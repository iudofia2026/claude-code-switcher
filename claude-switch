#!/bin/bash
# Claude Code Switcher - Easily switch between Z.AI and Anthropic models

# Colors for better UX
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# Config paths
CLAUDE_DIR="$HOME/.claude"
ACTIVE_CONFIG="$CLAUDE_DIR/settings.json"
ZAI_CONFIG="$CLAUDE_DIR/settings-zai.json"
ANTHROPIC_CONFIG="$CLAUDE_DIR/settings-anthropic.json"
BACKUP_DIR="$CLAUDE_DIR/backups"

# Helper functions
print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_header() {
    echo -e "${BOLD}$1${NC}"
}

# Validate JSON
validate_json() {
    local file="$1"
    if command -v python3 &> /dev/null; then
        python3 -m json.tool "$file" > /dev/null 2>&1
        return $?
    elif command -v jq &> /dev/null; then
        jq empty "$file" > /dev/null 2>&1
        return $?
    else
        # Basic check - just see if file exists and isn't empty
        [ -s "$file" ]
        return $?
    fi
}

# Backup current config
backup_config() {
    if [ -f "$ACTIVE_CONFIG" ]; then
        mkdir -p "$BACKUP_DIR"
        local timestamp=$(date +%Y%m%d_%H%M%S)
        cp "$ACTIVE_CONFIG" "$BACKUP_DIR/settings_${timestamp}.json"
        print_info "Backed up current config"
    fi
}

# Get current provider
get_current_provider() {
    if [ ! -f "$ACTIVE_CONFIG" ]; then
        echo "none"
        return
    fi
    
    if grep -q "z.ai" "$ACTIVE_CONFIG" 2>/dev/null; then
        echo "zai"
    elif grep -q "ANTHROPIC_BASE_URL" "$ACTIVE_CONFIG" 2>/dev/null && ! grep -q "z.ai" "$ACTIVE_CONFIG" 2>/dev/null; then
        echo "custom"
    else
        echo "anthropic"
    fi
}

# Show current status
show_status() {
    print_header "Current Configuration"
    echo ""
    
    if [ ! -f "$ACTIVE_CONFIG" ]; then
        print_error "No active configuration found"
        echo ""
        print_info "Run 'claude-switch zai' or 'claude-switch anthropic' to set up"
        return
    fi
    
    local provider=$(get_current_provider)
    
    case $provider in
        zai)
            print_success "Using Z.AI GLM Models"
            if [ -f "$ACTIVE_CONFIG" ]; then
                local base_url=$(grep -o '"ANTHROPIC_BASE_URL": "[^"]*"' "$ACTIVE_CONFIG" | cut -d'"' -f4)
                local model=$(grep -o '"model": "[^"]*"' "$ACTIVE_CONFIG" | cut -d'"' -f4)
                echo "  Endpoint: $base_url"
                echo "  Model: $model"
            fi
            ;;
        anthropic)
            print_success "Using Anthropic Claude Models"
            if [ -f "$ACTIVE_CONFIG" ]; then
                local model=$(grep -o '"model": "[^"]*"' "$ACTIVE_CONFIG" | cut -d'"' -f4)
                echo "  Model: $model"
            fi
            ;;
        custom)
            print_info "Using Custom Configuration"
            ;;
        none)
            print_error "No configuration found"
            ;;
    esac
    
    echo ""
    print_info "Config file: $ACTIVE_CONFIG"
}

# Switch to Z.AI
switch_to_zai() {
    print_header "Switching to Z.AI GLM Models..."
    echo ""
    
    # Check if Z.AI config exists
    if [ ! -f "$ZAI_CONFIG" ]; then
        print_error "Z.AI configuration not found"
        echo ""
        print_info "Run 'claude-switch setup-zai' to configure Z.AI"
        return 1
    fi
    
    # Validate Z.AI config
    if ! validate_json "$ZAI_CONFIG"; then
        print_error "Z.AI configuration is invalid"
        return 1
    fi
    
    # Check if API key is set
    if grep -q "YOUR_ZAI_API_KEY_HERE" "$ZAI_CONFIG" 2>/dev/null; then
        print_error "Z.AI API key not configured"
        echo ""
        print_info "Run 'claude-switch set-key YOUR_KEY' to add your API key"
        print_info "Get your key at: https://open.bigmodel.cn"
        return 1
    fi
    
    # Check if already on Z.AI
    local current=$(get_current_provider)
    if [ "$current" = "zai" ]; then
        print_warning "Already using Z.AI models"
        return 0
    fi
    
    # Backup and switch
    backup_config
    cp "$ZAI_CONFIG" "$ACTIVE_CONFIG"
    
    print_success "Switched to Z.AI models"
    echo ""
    show_status
    echo ""
    offer_restart
}

# Switch to Anthropic
switch_to_anthropic() {
    print_header "Switching to Anthropic Claude Models..."
    echo ""
    
    # Check if Anthropic config exists
    if [ ! -f "$ANTHROPIC_CONFIG" ]; then
        print_error "Anthropic configuration not found"
        return 1
    fi
    
    # Validate Anthropic config
    if ! validate_json "$ANTHROPIC_CONFIG"; then
        print_error "Anthropic configuration is invalid"
        return 1
    fi
    
    # Check if already on Anthropic
    local current=$(get_current_provider)
    if [ "$current" = "anthropic" ]; then
        print_warning "Already using Anthropic models"
        return 0
    fi
    
    # Backup and switch
    backup_config
    cp "$ANTHROPIC_CONFIG" "$ACTIVE_CONFIG"
    
    print_success "Switched to Anthropic models"
    echo ""
    show_status
    echo ""
    offer_restart
}

# Offer to restart Claude Code
offer_restart() {
    print_warning "Claude Code needs to restart for changes to take effect"
    echo ""
    read -p "Kill Claude Code processes now? (y/n): " -n 1 -r
    echo ""
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        if pkill -f "claude" 2>/dev/null; then
            print_success "Claude Code processes killed"
            echo ""
            print_info "Start Claude Code again with: ${BOLD}claude${NC}"
        else
            print_info "No Claude Code processes found running"
        fi
    else
        print_info "Remember to restart Claude Code manually"
    fi
}

# Set Z.AI API key
set_api_key() {
    local api_key="$1"
    
    if [ -z "$api_key" ]; then
        print_error "No API key provided"
        echo ""
        echo "Usage: claude-switch set-key YOUR_API_KEY"
        return 1
    fi
    
    # Basic validation - Z.AI keys are usually hex strings
    if [[ ! "$api_key" =~ ^[a-zA-Z0-9._-]+$ ]]; then
        print_warning "API key format looks unusual, but proceeding..."
    fi
    
    # Check if Z.AI config exists
    if [ ! -f "$ZAI_CONFIG" ]; then
        print_error "Z.AI configuration not found. Run installation first."
        return 1
    fi
    
    # Update the API key in Z.AI config
    if command -v python3 &> /dev/null; then
        python3 << EOF
import json
with open('$ZAI_CONFIG', 'r') as f:
    config = json.load(f)
config['env']['ANTHROPIC_AUTH_TOKEN'] = '$api_key'
with open('$ZAI_CONFIG', 'w') as f:
    json.dump(config, f, indent=2)
EOF
        print_success "API key updated in Z.AI configuration"
        
        # If currently using Z.AI, update active config too
        if [ "$(get_current_provider)" = "zai" ]; then
            cp "$ZAI_CONFIG" "$ACTIVE_CONFIG"
            print_success "Active configuration updated"
            echo ""
            offer_restart
        fi
    else
        # Fallback: sed replacement (less reliable but works)
        local escaped_key=$(echo "$api_key" | sed 's/[\/&]/\\&/g')
        sed -i.bak "s/\"ANTHROPIC_AUTH_TOKEN\": \"[^\"]*\"/\"ANTHROPIC_AUTH_TOKEN\": \"$escaped_key\"/" "$ZAI_CONFIG"
        rm -f "${ZAI_CONFIG}.bak"
        print_success "API key updated in Z.AI configuration"
    fi
}

# Setup Z.AI interactively
setup_zai() {
    print_header "Z.AI Setup Wizard"
    echo ""
    
    print_info "Get your API key from: https://open.bigmodel.cn"
    echo ""
    read -p "Enter your Z.AI API key: " api_key
    
    if [ -z "$api_key" ]; then
        print_error "No API key provided. Setup cancelled."
        return 1
    fi
    
    # Create config if it doesn't exist
    if [ ! -f "$ZAI_CONFIG" ]; then
        cat > "$ZAI_CONFIG" << 'EOF'
{
  "env": {
    "ANTHROPIC_AUTH_TOKEN": "YOUR_ZAI_API_KEY_HERE",
    "ANTHROPIC_BASE_URL": "https://api.z.ai/api/anthropic",
    "API_TIMEOUT_MS": "3000000",
    "CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC": "1"
  },
  "alwaysThinkingEnabled": false,
  "model": "opus"
}
EOF
    fi
    
    # Set the API key
    set_api_key "$api_key"
    
    echo ""
    print_success "Z.AI setup complete!"
    echo ""
    print_info "Switch to Z.AI with: ${BOLD}claude-switch zai${NC}"
}

# Edit configurations
edit_config() {
    local config_type="$1"
    local editor="${EDITOR:-nano}"
    
    case $config_type in
        zai)
            if [ ! -f "$ZAI_CONFIG" ]; then
                print_error "Z.AI configuration not found"
                return 1
            fi
            $editor "$ZAI_CONFIG"
            print_success "Z.AI configuration edited"
            ;;
        anthropic)
            if [ ! -f "$ANTHROPIC_CONFIG" ]; then
                print_error "Anthropic configuration not found"
                return 1
            fi
            $editor "$ANTHROPIC_CONFIG"
            print_success "Anthropic configuration edited"
            ;;
        *)
            print_error "Unknown config type. Use 'zai' or 'anthropic'"
            return 1
            ;;
    esac
}

# Show help
show_help() {
    cat << EOF
${BOLD}Claude Code Switcher${NC}
Easily switch between Z.AI GLM models and Anthropic Claude models

${BOLD}USAGE:${NC}
  claude-switch <command> [arguments]

${BOLD}COMMANDS:${NC}
  ${GREEN}zai${NC}                Switch to Z.AI GLM models
  ${GREEN}anthropic${NC}          Switch to Anthropic Claude models
  ${GREEN}status${NC}             Show current configuration
  
  ${BLUE}setup-zai${NC}          Interactive Z.AI setup wizard
  ${BLUE}set-key${NC} <key>      Set Z.AI API key
  
  ${YELLOW}edit-zai${NC}          Edit Z.AI configuration
  ${YELLOW}edit-anthropic${NC}   Edit Anthropic configuration
  
  ${YELLOW}help${NC}              Show this help message

${BOLD}EXAMPLES:${NC}
  claude-switch zai               # Switch to Z.AI
  claude-switch anthropic         # Switch to Anthropic
  claude-switch status            # Check current setup
  claude-switch set-key abc123    # Update Z.AI API key
  claude-switch setup-zai         # Run Z.AI setup wizard

${BOLD}NOTES:${NC}
  • After switching, restart Claude Code for changes to take effect
  • Get Z.AI API key from: https://open.bigmodel.cn
  • Configuration files stored in: ~/.claude/

For more information: https://github.com/iudofia2026/claude-code-switcher
EOF
}

# Main command router
main() {
    local command="${1:-status}"
    
    case $command in
        zai)
            switch_to_zai
            ;;
        anthropic)
            switch_to_anthropic
            ;;
        status)
            show_status
            ;;
        set-key)
            set_api_key "$2"
            ;;
        setup-zai)
            setup_zai
            ;;
        edit-zai)
            edit_config "zai"
            ;;
        edit-anthropic)
            edit_config "anthropic"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            print_error "Unknown command: $command"
            echo ""
            show_help
            return 1
            ;;
    esac
}

main "$@"
